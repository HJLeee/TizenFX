<Project DefaultTargets="Build">

  <Import Project="Sdk.props" Sdk="Microsoft.NET.Sdk" />

  <Import Project="$(MSBuildThisFileDirectory)directories.props" />
  <Import Project="$(MSBuildThisFileDirectory)version.props" />

  <PropertyGroup>
    <TargetFramework>netstandard2.0</TargetFramework>
    <GenerateDependencyFile>false</GenerateDependencyFile>
    <DummyAssemblyVersion>$(VersionPrefix)</DummyAssemblyVersion>
    <OutDir>$(OutputDummyDir)</OutDir>
  </PropertyGroup>

  <!-- Properties for directories -->
  <PropertyGroup>
    <IntermediateLibDir>$(BaseIntermediateOutputPath)_ref_lib\</IntermediateLibDir>
    <IntermediateAPIDir>$(BaseIntermediateOutputPath)_ref_api\</IntermediateAPIDir>
  </PropertyGroup>

  <!-- Properties for GenAPI tool -->
  <PropertyGroup>
    <GenAPICommand>dotnet $(GenAPIDir)GenAPI.exe</GenAPICommand>
  </PropertyGroup>

  <!-- Source assemblies -->
  <ItemGroup>
    <TizenAssemblies Include="$(OutputPublicDir)\*.dll" />
    <TizenAssemblies Include="$(OutputInternalDir)\*.dll" />
  </ItemGroup>

  <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk" />

  <Target Name="Compile" />
  <Target Name="CopyFilesToOutputDirectory" />

  <!-- Target for preparing reference lib directory -->
  <Target Name="Prepare" DependsOnTargets="ResolveAssemblyReferences">
    <ItemGroup>
      <ReferencePath Include="@(TizenAssemblies)" />
    </ItemGroup>
    <MakeDir Directories="$(IntermediateLibDir);$(IntermediateAPIDir)" />
    <Copy SourceFiles="@(ReferencePath)" DestinationFolder="$(IntermediateLibDir)" />
    <RemoveDir Directories="$(OutputDummyDir)" />
    <MakeDir Directories="$(OutputDummyDir)" />
  </Target>

  <!-- Target for generating *.AssemblyInfo.cs files -->
  <Target Name="GenerateAsmInfo"
          Inputs="@(TizenAssemblies)" Outputs="$(IntermediateAPIDir)%(Filename).AssemblyInfo.cs">

    <PropertyGroup>
      <GeneratedAssemblyInfoSource>$(IntermediateAPIDir)%(TizenAssemblies.Filename).AssemblyInfo.cs</GeneratedAssemblyInfoSource>
    </PropertyGroup>

    <ItemGroup>
      <AssemblyInfoLines Include="[assembly:System.Reflection.AssemblyVersion(&quot;$(DummyAssemblyVersion)&quot;)]" />
    </ItemGroup>

    <WriteLinesToFile
      File="$(GeneratedAssemblyInfoSource)"
      Lines="@(AssemblyInfoLines)"
      Overwrite="true" />

    <ItemGroup>
      <FileWrites Include="$(GeneratedAssemblyInfoSource)" />
    </ItemGroup>

  </Target>

  <!-- Target for generating reference source files using GenAPI -->
  <Target Name="GenerateAPI"
          Inputs="@(TizenAssemblies)" Outputs="$(IntermediateAPIDir)%(Filename).cs">
    <PropertyGroup>
      <GeneratedReferenceAssemblySource>$(IntermediateAPIDir)%(TizenAssemblies.Filename).cs</GeneratedReferenceAssemblySource>
    </PropertyGroup>

    <Message Text="[GenAPI] %(TizenAssemblies.Filename) -> $(GeneratedReferenceAssemblySource)" Importance="High" />

    <Exec Command='$(GenAPICommand) -assembly:&quot;%(TizenAssemblies.Identity)&quot; -libPath:$(IntermediateLibDir) -out:$(GeneratedReferenceAssemblySource) -throw:&quot;Not Supported Feature&quot; -global' />
  </Target>


  <Target Name="GenerateDummy"
          DependsOnTargets="GenerateAsmInfo;GenerateAPI"
          Inputs="@(TizenAssemblies)" Outputs="$(OutputDummyDir)%(TizenAssemblies.Filename).dll">
    <PropertyGroup>
      <ThisAssemblyFilename>%(TizenAssemblies.Filename)</ThisAssemblyFilename>
      <GeneratedAssemblyInfoSource>$(IntermediateAPIDir)%(TizenAssemblies.Filename).AssemblyInfo.cs</GeneratedAssemblyInfoSource>
      <GeneratedReferenceAssemblySource>$(IntermediateAPIDir)%(TizenAssemblies.Filename).cs</GeneratedReferenceAssemblySource>
      <GeneratedReferenceAssembly>$(OutputDummyDir)%(TizenAssemblies.Filename).dll</GeneratedReferenceAssembly>
    </PropertyGroup>

    <Message Text="[Compile] %(TizenAssemblies.Filename) -> $(GeneratedReferenceAssembly)" Importance="High" />

    <ItemGroup>
      <FilteredReferencePath Include="@(ReferencePath)" Condition="%(Filename) != $(ThisAssemblyFilename)" />
    </ItemGroup>

    <Csc
        Sources="$(GeneratedReferenceAssemblySource);$(GeneratedAssemblyInfoSource)"
        OutputAssembly="$(GeneratedReferenceAssembly)"
        AdditionalLibPaths="$(AdditionalLibPaths)"
        AllowUnsafeBlocks="true"
        DefineConstants="$(DefineConstants)"
        DisabledWarnings="$(NoWarn)"
        TargetType="$(OutputType)"
        NoStandardLib="$(NoCompilerStandardLib)"
        References="@(FilteredReferencePath)"
        Deterministic="true"
        ToolExe="$(CscToolExe)"
        ToolPath="$(CscToolPath)" />

  </Target>

  <Target Name="AfterBuild" DependsOnTargets="Prepare;GenerateDummy">
    <RemoveDir Directories="$(BaseIntermediateOutputPath)" />
  </Target>

</Project>

